<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IP Camera + Gemini Vision</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }
    .floating {
      animation: float 3s ease-in-out infinite;
    }
    .chat-bubble {
      position: relative;
      border-radius: 1.5rem;
      padding: 1.25rem;
      margin-bottom: 1rem;
      max-width: 80%;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
    }
    .chat-bubble:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .user-bubble {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 0.5rem;
    }
    .bot-bubble {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      color: #111827;
      margin-right: auto;
      border-bottom-left-radius: 0.5rem;
    }
    .camera-feed {
      border-radius: 1rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      transition: all 0.3s ease;
    }
    .camera-feed:hover {
      transform: scale(1.02);
    }
    .glow-btn {
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
    }
    .glow-btn:hover {
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.8);
      transform: translateY(-2px);
    }
    .pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    /* Responsive adjustments */
    @media (max-width: 640px) {
      #chat-box {
        height: 300px !important;
      }
      .chat-bubble {
        max-width: 95%;
        font-size: 0.9rem;
      }
      .glow-btn {
        padding-left: 1rem;
        padding-right: 1rem;
        font-size: 0.875rem;
      }
      .camera-feed {
        max-height: 250px;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="w-full px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header with animated icon -->
    <div class="text-center mb-8" data-aos="fade-down">
      <div class="inline-block p-4 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 shadow-xl">
        <i data-feather="camera" class="w-12 h-12 text-white floating"></i>
      </div>
      <h1 class="mt-4 text-3xl font-bold text-gray-900 sm:text-4xl md:text-5xl">
        <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
          Smart Camera Vision
        </span>
      </h1>
      <p class="mt-3 max-w-2xl mx-auto text-xl text-gray-500 sm:mt-4">
        Real-time IP camera with Gemini AI integration
      </p>
    </div>

    <!-- Main content area -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-[75vh]">
      <!-- Camera feed section -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden" data-aos="fade-right">
        <div class="p-4 bg-gradient-to-r from-blue-600 to-indigo-600">
          <h2 class="text-lg font-semibold text-white flex items-center">
            <i data-feather="video" class="mr-2"></i> Live Camera Feed
          </h2>
        </div>
        <div class="p-4">
          <div class="aspect-w-16 aspect-h-9 bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center">
            <!-- Video element for device camera -->
            <video id="deviceCamera" autoplay playsinline muted class="camera-feed hidden"></video>
            <!-- Image element for IP camera -->
            <img id="cameraFeed" src="http://static.photos/technology/1024x576/42" alt="Camera Feed" class="camera-feed w-full h-auto">
          </div>
          <div class="mt-6 flex justify-center space-x-4 flex-wrap">
            <button id="startBtn" class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-medium rounded-full glow-btn flex items-center">
              <i data-feather="play" class="mr-2"></i> Start
            </button>
            <button id="screenshotBtn" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-full glow-btn pulse flex items-center">
              <i data-feather="camera" class="mr-2"></i> Capture
            </button>
            <button id="autoCaptureBtn" class="px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white font-medium rounded-full glow-btn flex items-center">
              <i data-feather="repeat" class="mr-2"></i> Auto Capture
            </button>
            <button id="stopBtn" class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white font-medium rounded-full glow-btn flex items-center">
              <i data-feather="stop-circle" class="mr-2"></i> Stop
            </button>
            <label class="px-6 py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-medium rounded-full glow-btn flex items-center cursor-pointer">
              <i data-feather="upload" class="mr-2"></i> Upload Image
              <input type="file" id="imageUpload" accept="image/*" class="hidden">
            </label>
          </div>
        </div>
      </div>

      <!-- Chat section -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden" data-aos="fade-left">
        <div class="p-4 bg-gradient-to-r from-indigo-600 to-purple-600">
          <h2 class="text-lg font-semibold text-white flex items-center">
            <i data-feather="message-square" class="mr-2"></i> Gemini Vision Chat
          </h2>
        </div>
        <div class="p-4">
          <div id="chat-box" class="h-[500px] overflow-y-auto p-3 space-y-3 bg-gray-50 rounded-lg">
            <div class="chat-bubble bot-bubble">
              <div class="flex items-start">
                <div class="flex-shrink-0 h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center">
                  <i data-feather="cpu" class="text-indigo-600 w-4 h-4"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm font-medium text-gray-900">Gemini Vision</p>
                  <p class="mt-1 text-sm text-gray-700">Hello! I'm ready to analyze your camera feed. Click "Capture" to get started.</p>
                </div>
              </div>
            </div>
          </div>

          <div id="loadingSpinner" class="mt-4 hidden flex justify-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Features section -->
    <div class="mt-16" data-aos="fade-up">
      <h2 class="text-2xl font-bold text-center text-gray-900 mb-8">Key Features</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow">
          <div class="flex items-center mb-4">
            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
              <i data-feather="eye" class="w-6 h-6"></i>
            </div>
            <h3 class="ml-3 text-lg font-medium text-gray-900">Real-time Analysis</h3>
          </div>
          <p class="text-gray-600">Get instant AI-powered analysis of your camera feed with Gemini Vision technology.</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow">
          <div class="flex items-center mb-4">
            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
              <i data-feather="shield" class="w-6 h-6"></i>
            </div>
            <h3 class="ml-3 text-lg font-medium text-gray-900">Secure Connection</h3>
          </div>
          <p class="text-gray-600">Your camera feed is processed securely with end-to-end encryption for privacy.</p>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow">
          <div class="flex items-center mb-4">
            <div class="p-3 rounded-full bg-green-100 text-green-600">
              <i data-feather="zap" class="w-6 h-6"></i>
            </div>
            <h3 class="ml-3 text-lg font-medium text-gray-900">Smart Alerts</h3>
          </div>
          <p class="text-gray-600">Receive intelligent notifications for important events detected in your camera feed.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    AOS.init();
    feather.replace();

    const chatBox = document.getElementById("chat-box");
    const spinner = document.getElementById("loadingSpinner");
    const cameraFeed = document.getElementById("cameraFeed");
    const deviceCamera = document.getElementById("deviceCamera");

    // Your IP Camera snapshot URL
    // const snapshotUrl = "http://192.168.225.53:8080/shot.jpg";

    // Detect if device is mobile
    // const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    // Stream from device camera (all devices)
    async function startDeviceCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: "environment" } },
          audio: false,
        });
        deviceCamera.srcObject = stream;
        deviceCamera.classList.remove("hidden");
        cameraFeed.classList.add("hidden");
      } catch (err) {
        addBubble("Error accessing device camera: " + err.message, "bot");
      }
    }

    // Start device camera feed (used for all devices)
    function startDeviceCameraFeed() {
      deviceCamera.classList.remove("hidden");
      cameraFeed.classList.add("hidden");
    }

    // Start button handler
    document.getElementById("startBtn").addEventListener("click", () => {
      startDeviceCamera();
      addBubble("📷 Device camera started", "bot");
    });

    // Capture screenshot from the active camera feed
    async function takeScreenshot() {
      spinner.classList.remove("hidden");
      try {
        let base64data;
        // Check if device camera is started
        if (!deviceCamera.srcObject) {
          await startDeviceCamera();
          // Wait a bit for the video to load
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
        // Ensure video dimensions are available
        if (deviceCamera.videoWidth === 0 || deviceCamera.videoHeight === 0) {
          throw new Error("Camera not ready. Please try again.");
        }
        // Capture from device camera video element
        const canvas = document.createElement("canvas");
        canvas.width = deviceCamera.videoWidth;
        canvas.height = deviceCamera.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(deviceCamera, 0, 0, canvas.width, canvas.height);
        base64data = canvas.toDataURL("image/jpeg");

        // Update camera feed image
        cameraFeed.src = base64data;

        // Show snapshot in chat bubble
        const img = document.createElement("img");
        img.src = base64data;
        img.classList.add("rounded-lg", "w-full", "h-auto", "max-h-48", "object-cover");
        addBubble(img, "user");

        // Send to Flask backend
        const res = await fetch("http://127.0.0.1:5000/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image: base64data })
        });

        const result = await res.json();
        addBubble(result.reply || "I couldn't analyze this image. Please try again.", "bot");
        spinner.classList.add("hidden");
      } catch (err) {
        addBubble("Error: " + err.message, "bot");
        spinner.classList.add("hidden");
      }
    }

    // Handle image upload
    async function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      spinner.classList.remove("hidden");
      try {
        const reader = new FileReader();
        reader.onload = async function(e) {
          const base64data = e.target.result;

          // Show uploaded image in chat bubble
          const img = document.createElement("img");
          img.src = base64data;
          img.classList.add("rounded-lg", "w-full", "h-auto", "max-h-48", "object-cover");
          addBubble(img, "user");

          // Send to Flask backend
          const res = await fetch("http://127.0.0.1:5000/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ image: base64data })
          });

          const result = await res.json();
          addBubble(result.reply || "I couldn't analyze this image. Please try again.", "bot");
          spinner.classList.add("hidden");
        };
        reader.readAsDataURL(file);
      } catch (err) {
        addBubble("Error uploading image: " + err.message, "bot");
        spinner.classList.add("hidden");
      }
    }

    let autoInterval = null;
    const autoCaptureBtn = document.getElementById("autoCaptureBtn");

    function toggleAutoCapture() {
      if (autoInterval) {
        clearInterval(autoInterval);
        autoInterval = null;
        autoCaptureBtn.innerHTML = '<i data-feather="repeat" class="mr-2"></i> Auto Capture';
        addBubble("Auto capture stopped", "bot");
      } else {
        autoInterval = setInterval(takeScreenshot, 25000);
        autoCaptureBtn.innerHTML = '<i data-feather="stop-circle" class="mr-2"></i> Stop Auto';
        addBubble("Auto capture started - taking screenshots every 25 seconds", "bot");
      }
      feather.replace();
    }

    // Button bindings
    document.getElementById("screenshotBtn").addEventListener("click", takeScreenshot);
    document.getElementById("stopBtn").addEventListener("click", () => {
      addBubble("❌ Camera feed stopped", "bot");
      cameraFeed.src = "http://static.photos/technology/1024x576/42";
      cameraFeed.classList.remove("hidden");
      deviceCamera.classList.add("hidden");
      if (autoInterval) {
        clearInterval(autoInterval);
        autoInterval = null;
        autoCaptureBtn.innerHTML = '<i data-feather="repeat" class="mr-2"></i> Auto Capture';
        feather.replace();
      }
    });
    autoCaptureBtn.addEventListener("click", toggleAutoCapture);

    // Image upload binding
    document.getElementById("imageUpload").addEventListener("change", handleImageUpload);

    // Helper function to add chat bubbles
    function addBubble(content, type) {
      const bubble = document.createElement("div");
      bubble.classList.add("chat-bubble", type === "user" ? "user-bubble" : "bot-bubble");

      if (type === "bot") {
        bubble.innerHTML = `
          <div class="flex items-start">
            <div class="flex-shrink-0 h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center">
              <i data-feather="cpu" class="text-indigo-600 w-4 h-4"></i>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-gray-900">Gemini Vision</p>
              <div class="mt-1 text-sm text-gray-700">${content}</div>
            </div>
          </div>
        `;
      } else {
        bubble.appendChild(content);
      }

      chatBox.appendChild(bubble);
      chatBox.scrollTop = chatBox.scrollHeight;
      feather.replace();
    }
  </script>
</body>
</html>
