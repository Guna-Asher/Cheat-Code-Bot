<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IP Camera + Gemini Vision</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    /* Simplified styles without animations or glow effects */
    .chat-bubble {
      position: relative;
      border-radius: 1.5rem;
      padding: 1.25rem;
      margin-bottom: 1rem;
      max-width: 80%;
    }
    .user-bubble {
      background: #3b82f6;
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 0.5rem;
    }
    .bot-bubble {
      background: #f3f4f6;
      color: #111827;
      margin-right: auto;
      border-bottom-left-radius: 0.5rem;
    }
    .camera-feed {
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
    }
    
    /* Mobile-first responsive design */
    @media (max-width: 768px) {
      .button-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        margin-top: 1rem;
      }
      .button-grid .btn {
        padding: 0.5rem;
        font-size: 0.75rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
      }
      .button-grid .btn i {
        margin-right: 0;
        margin-bottom: 0.25rem;
      }
      .button-grid .btn span {
        text-align: center;
      }
      #chat-box {
        height: 300px !important;
      }
      .camera-container {
        height: 200px;
      }
    }
    
    @media (max-width: 480px) {
      .button-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .button-grid .btn {
        padding: 0.4rem;
        font-size: 0.7rem;
      }
      #chat-box {
        height: 250px !important;
      }
      .camera-container {
        height: 180px;
      }
    }
    
    @media (min-width: 769px) {
      .button-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
      }
      .button-grid .btn {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
      }
    }
    
    /* Landscape orientation for mobile */
    @media (orientation: landscape) and (max-width: 1000px) {
      .grid.grid-cols-1.lg\:grid-cols-2 {
        grid-template-columns: 1fr 1fr;
      }
      #chat-box {
        height: 200px !important;
      }
      .camera-container {
        height: 150px;
      }
      .button-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    /* Q&A specific styling */
    .qa-container {
      line-height: 1.6;
    }
    .qa-question {
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    .qa-answer {
      font-weight: bold;
      color: #059669; /* Green color for answers to distinguish them */
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="w-full px-4 sm:px-6 lg:px-8 py-4">
    <!-- Header -->
    <div class="text-center mb-6">
      <div class="inline-block p-3 rounded-full bg-blue-500">
        <i data-feather="camera" class="w-8 h-8 text-white"></i>
      </div>
      <h1 class="mt-3 text-2xl font-bold text-gray-900 sm:text-3xl">
        <span class="text-blue-600">
          Smart Camera Vision
        </span>
      </h1>
      <p class="mt-2 max-w-2xl mx-auto text-lg text-gray-500">
        Real-time IP camera with Gemini AI integration
      </p>
    </div>

    <!-- Main content area -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Camera feed section -->
      <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="p-3 bg-blue-600">
          <h2 class="text-md font-semibold text-white flex items-center">
            <i data-feather="video" class="mr-2"></i> Live Camera Feed
          </h2>
        </div>
        <div class="p-3">
          <div class="camera-container bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center">
            <!-- Video element for device camera -->
            <video id="deviceCamera" autoplay playsinline muted class="camera-feed hidden w-full h-full object-cover"></video>
            <!-- Image element for IP camera -->
            <img id="cameraFeed" src="http://static.photos/technology/1024x576/42" alt="Camera Feed" class="camera-feed w-full h-full object-cover">
          </div>
          
          <!-- Button grid for all actions -->
          <div class="button-grid">
            <button id="startBtn" class="btn bg-green-500 hover:bg-green-600 text-white font-medium rounded">
              <i data-feather="play" class="w-4 h-4"></i>
              <span>Start</span>
            </button>
            <button id="screenshotBtn" class="btn bg-blue-500 hover:bg-blue-600 text-white font-medium rounded">
              <i data-feather="camera" class="w-4 h-4"></i>
              <span>Capture</span>
            </button>
            <button id="autoCaptureBtn" class="btn bg-purple-500 hover:bg-purple-600 text-white font-medium rounded">
              <i data-feather="repeat" class="w-4 h-4"></i>
              <span>Auto</span>
            </button>
            <button id="stopBtn" class="btn bg-red-500 hover:bg-red-600 text-white font-medium rounded">
              <i data-feather="stop-circle" class="w-4 h-4"></i>
              <span>Stop</span>
            </button>
            <label class="btn bg-indigo-500 hover:bg-indigo-600 text-white font-medium rounded cursor-pointer">
              <i data-feather="upload" class="w-4 h-4"></i>
              <span>Upload</span>
              <input type="file" id="imageUpload" accept="image/*" class="hidden">
            </label>
          </div>
        </div>
      </div>

      <!-- Chat section -->
      <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="p-3 bg-indigo-600">
          <h2 class="text-md font-semibold text-white flex items-center">
            <i data-feather="message-square" class="mr-2"></i> Gemini Vision Chat
          </h2>
        </div>
        <div class="p-3">
          <div id="chat-box" class="h-[400px] overflow-y-auto p-3 space-y-3 bg-gray-50 rounded-lg">
            <div class="chat-bubble bot-bubble">
              <div class="flex items-start">
                <div class="flex-shrink-0 h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center">
                  <i data-feather="cpu" class="text-indigo-600 w-4 h-4"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm font-medium text-gray-900">Gemini Vision</p>
                  <p class="mt-1 text-sm text-gray-700">Hello! I'm ready to analyze your camera feed. Click "Capture" to get started.</p>
                </div>
              </div>
            </div>
          </div>

          <div id="loadingSpinner" class="mt-4 hidden flex justify-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Features section - hidden on mobile -->
    <div class="mt-8 features-section hidden md:block">
      <h2 class="text-xl font-bold text-center text-gray-900 mb-6">Key Features</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white p-4 rounded-lg shadow-sm">
          <div class="flex items-center mb-3">
            <div class="p-2 rounded-full bg-blue-100 text-blue-600">
              <i data-feather="eye" class="w-5 h-5"></i>
            </div>
            <h3 class="ml-3 text-md font-medium text-gray-900">Real-time Analysis</h3>
          </div>
          <p class="text-gray-600 text-sm">Get instant AI-powered analysis of your camera feed with Gemini Vision technology.</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-sm">
          <div class="flex items-center mb-3">
            <div class="p-2 rounded-full bg-purple-100 text-purple-600">
              <i data-feather="shield" class="w-5 h-5"></i>
            </div>
            <h3 class="ml-3 text-md font-medium text-gray-900">Secure Connection</h3>
          </div>
          <p class="text-gray-600 text-sm">Your camera feed is processed securely with end-to-end encryption for privacy.</p>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-sm">
          <div class="flex items-center mb-3">
            <div class="p-2 rounded-full bg-green-100 text-green-600">
              <i data-feather="zap" class="w-5 h-5"></i>
            </div>
            <h3 class="ml-3 text-md font-medium text-gray-900">Smart Alerts</h3>
          </div>
          <p class="text-gray-600 text-sm">Receive intelligent notifications for important events detected in your camera feed.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    AOS.init();
    feather.replace();

    const chatBox = document.getElementById("chat-box");
    const spinner = document.getElementById("loadingSpinner");
    const cameraFeed = document.getElementById("cameraFeed");
    const deviceCamera = document.getElementById("deviceCamera");

    // Stream from device camera (all devices)
    async function startDeviceCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: "environment" } },
          audio: false,
        });
        deviceCamera.srcObject = stream;
        deviceCamera.classList.remove("hidden");
        cameraFeed.classList.add("hidden");
      } catch (err) {
        addBubble("Error accessing device camera: " + err.message, "bot");
      }
    }

    // Start device camera feed (used for all devices)
    function startDeviceCameraFeed() {
      deviceCamera.classList.remove("hidden");
      cameraFeed.classList.add("hidden");
    }

    // Start button handler
    document.getElementById("startBtn").addEventListener("click", () => {
      startDeviceCamera();
      addBubble("📷 Device camera started", "bot");
    });

    // Capture screenshot from the active camera feed
    async function takeScreenshot() {
      spinner.classList.remove("hidden");
      try {
        let base64data;
        // Check if device camera is started
        if (!deviceCamera.srcObject) {
          await startDeviceCamera();
          // Wait a bit for the video to load
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
        // Ensure video dimensions are available
        if (deviceCamera.videoWidth === 0 || deviceCamera.videoHeight === 0) {
          throw new Error("Camera not ready. Please try again.");
        }
        // Capture from device camera video element
        const canvas = document.createElement("canvas");
        canvas.width = deviceCamera.videoWidth;
        canvas.height = deviceCamera.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(deviceCamera, 0, 0, canvas.width, canvas.height);
        base64data = canvas.toDataURL("image/jpeg");

        // Update camera feed image
        cameraFeed.src = base64data;

        // Show snapshot in chat bubble
        const img = document.createElement("img");
        img.src = base64data;
        img.classList.add("rounded-lg", "w-full", "h-auto", "max-h-48", "object-cover");
        addBubble(img, "user");

        // Send to Flask backend
        const res = await fetch("/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image: base64data })
        });

        const result = await res.json();
        addBubble(result.reply || "I couldn't analyze this image. Please try again.", "bot");
        spinner.classList.add("hidden");
      } catch (err) {
        addBubble("Error: " + err.message, "bot");
        spinner.classList.add("hidden");
      }
    }

    // Handle image upload
    async function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      spinner.classList.remove("hidden");
      try {
        const reader = new FileReader();
        reader.onload = async function(e) {
          const base64data = e.target.result;

          // Show uploaded image in chat bubble
          const img = document.createElement("img");
          img.src = base64data;
          img.classList.add("rounded-lg", "w-full", "h-auto", "max-h-48", "object-cover");
          addBubble(img, "user");

          // Send to Flask backend
          const res = await fetch("/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ image: base64data })
          });

          const result = await res.json();
          addBubble(result.reply || "I couldn't analyze this image. Please try again.", "bot");
          spinner.classList.add("hidden");
        };
        reader.readAsDataURL(file);
      } catch (err) {
        addBubble("Error uploading image: " + err.message, "bot");
        spinner.classList.add("hidden");
      }
    }

    let autoInterval = null;
    const autoCaptureBtn = document.getElementById("autoCaptureBtn");

    function toggleAutoCapture() {
      if (autoInterval) {
        clearInterval(autoInterval);
        autoInterval = null;
        autoCaptureBtn.innerHTML = '<i data-feather="repeat" class="w-4 h-4"></i><span>Auto</span>';
        addBubble("Auto capture stopped", "bot");
      } else {
        autoInterval = setInterval(takeScreenshot, 25000);
        autoCaptureBtn.innerHTML = '<i data-feather="stop-circle" class="w-4 h-4"></i><span>Stop Auto</span>';
        addBubble("Auto capture started - taking screenshots every 25 seconds", "bot");
      }
      feather.replace();
    }

    // Button bindings
    document.getElementById("screenshotBtn").addEventListener("click", takeScreenshot);
    document.getElementById("stopBtn").addEventListener("click", () => {
      addBubble("❌ Camera feed stopped", "bot");
      cameraFeed.src = "http://static.photos/technology/1024x576/42";
      cameraFeed.classList.remove("hidden");
      deviceCamera.classList.add("hidden");
      if (autoInterval) {
        clearInterval(autoInterval);
        autoInterval = null;
        autoCaptureBtn.innerHTML = '<i data-feather="repeat" class="w-4 h-4"></i><span>Auto</span>';
        feather.replace();
      }
    });
    autoCaptureBtn.addEventListener("click", toggleAutoCapture);

    // Image upload binding
    document.getElementById("imageUpload").addEventListener("change", handleImageUpload);

    // Helper function to add chat bubbles
    function addBubble(content, type) {
      const bubble = document.createElement("div");
      bubble.classList.add("chat-bubble", type === "user" ? "user-bubble" : "bot-bubble");

      if (type === "bot") {
        // Check if content contains HTML tags (Q&A format)
        if (typeof content === 'string' && (content.includes('<b>') || content.includes('<br>'))) {
          bubble.innerHTML = `
            <div class="flex items-start">
              <div class="flex-shrink-0 h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center">
                <i data-feather="cpu" class="text-indigo-600 w-4 h-4"></i>
              </div>
              <div class="ml-3">
                <p class="text-sm font-medium text-gray-900">Gemini Vision</p>
                <div class="mt-1 text-sm text-gray-700 qa-container">${content}</div>
              </div>
            </div>
          `;
        } else {
          bubble.innerHTML = `
            <div class="flex items-start">
              <div class="flex-shrink-0 h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center">
                <i data-feather="cpu" class="text-indigo-600 w-4 h-4"></i>
              </div>
              <div class="ml-3">
                <p class="text-sm font-medium text-gray-900">Gemini Vision</p>
                <p class="mt-1 text-sm text-gray-700">${content}</p>
              </div>
            </div>
          `;
        }
      } else {
        // Handle user content (could be text or image)
        if (typeof content === 'string') {
          bubble.innerHTML = content;
        } else {
          bubble.appendChild(content);
        }
      }

      chatBox.appendChild(bubble);
      chatBox.scrollTop = chatBox.scrollHeight;
      feather.replace();
    }
  </script>
</body>
</html>
